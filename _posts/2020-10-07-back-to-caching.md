---
published: true
---
## I Skipped Bucket Day

I'm back, and I'm about to get even deeper into zink's descriptor management. I figured everyone including me is well acquainted with bucket allocating, so I skipped that day and we can all just imagine what that post would've been like instead.

Let's talk about caching and descriptor sets.

I talked about it before, I know, so here's a brief reminder of where I left off:
[![](https://mermaid.ink/img/eyJjb2RlIjoic3RhdGVEaWFncmFtXG5zdGF0ZSBcImNyZWF0ZSBoYXNoIGZvciBjdXJyZW50IGRlc2NyaXB0b3Igc3RhdGVcIiBhcyBzMVxuc3RhdGUgXCJjaGVjayBwcm9ncmFtIGNhY2hlIGZvciBtYXRjaGluZyBzZXRcIiBhcyBzMlxuc3RhdGUgXCJtYXRjaCBmb3VuZFwiIGFzIHMzXG5zdGF0ZSBcInJldHVybiBkZXNjcmlwdG9yIHNldFwiIGFzIHM0XG5zdGF0ZSBcIm1hdGNoIG5vdCBmb3VuZFwiIGFzIHM1XG5zdGF0ZSBcImNoZWNrIHByb2dyYW0gZm9yIHVudXNlZCBzZXRcIiBhcyBzNlxuc3RhdGUgXCJ1bnVzZWQgc2V0IGZvdW5kXCIgYXMgczdcbnN0YXRlIFwiYXNzb2NpYXRlIHNldCB3aXRoIGRlc2NyaXB0b3Igc3RhdGVcIiBhcyBzOFxuc3RhdGUgXCJ1bnVzZWQgc2V0IG5vdCBmb3VuZFwiIGFzIHM5XG5zdGF0ZSBcImFsbG9jYXRlIG5ldyBzZXRcIiBhcyBzMTBcbnN0YXRlIFwicmVzb3VyY2UgaXMgZGVzdHJveWVkXCIgYXMgczExXG5zdGF0ZSBcImFzc29jaWF0ZSByZXNvdXJjZXMgd2l0aCBzZXRcIiBhcyBzMTJcbnN0YXRlIFwiaW52YWxpZGF0ZSBhc3NvY2lhdGVkIHNldHNcIiBhcyBzMTNcbnN0YXRlIFwibW92ZSBpbnZhbGlkYXRlZCBzZXRzIHRvIGludmFsaWRhdGVkIHNldCBhcnJheVwiIGFzIHMxNFxuc3RhdGUgXCJpbnZhbGlkYXRlIHNldFwiIGFzIHMxNlxuc3RhdGUgXCJzZXQgaXMgdmFsaWRcIiBhcyBzMTdcbnN0YXRlIFwic2V0IGlzIG5vdCB2YWxpZFwiIGFzIHMxOFxuc3RhdGUgXCJjaGVjayBwcm9ncmFtIGludmFsaWRhdGVkIHNldCBhcnJheVwiIGFzIHMxOVxuc3RhdGUgXCJpbnZhbGlkYXRlZCBzZXQgbm90IGZvdW5kXCIgYXMgczIwXG5zdGF0ZSBcImludmFsaWRhdGVkIHNldCBmb3VuZFwiIGFzIHMyMVxuWypdIC0tPiBzMVxuczEgLS0-IHMyXG5zMiAtLT4gczNcbnMzIC0tPiBzNFxuczIgLS0-IHM1XG5zNSAtLT4gczE5XG5zMTkgLS0-IHMyMVxuczIxIC0tPiBzOFxuczE5IC0tPiBzMjBcbnMyMCAtLT4gczZcbnM2IC0tPiBzN1xuczcgLS0-IHMxN1xuczE3IC0tPiBzMTZcbnMxNiAtLT4gczhcbnM3IC0tPiBzMThcbnMxOCAtLT4gczhcbnM4IC0tPiBzMTJcbnMxMiAtLT4gczRcbnM2IC0tPiBzOVxuczkgLS0-IHMxMFxuczEwIC0tPiBzOFxuWypdIC0tPiBzMTFcbnMxMSAtLT4gczEzXG5zMTMgLS0-IHMxNCIsIm1lcm1haWQiOnsidGhlbWUiOiJkZWZhdWx0IiwidGhlbWVWYXJpYWJsZXMiOnsiYmFja2dyb3VuZCI6IndoaXRlIiwicHJpbWFyeUNvbG9yIjoiI0VDRUNGRiIsInNlY29uZGFyeUNvbG9yIjoiI2ZmZmZkZSIsInRlcnRpYXJ5Q29sb3IiOiJoc2woODAsIDEwMCUsIDk2LjI3NDUwOTgwMzklKSIsInByaW1hcnlCb3JkZXJDb2xvciI6ImhzbCgyNDAsIDYwJSwgODYuMjc0NTA5ODAzOSUpIiwic2Vjb25kYXJ5Qm9yZGVyQ29sb3IiOiJoc2woNjAsIDYwJSwgODMuNTI5NDExNzY0NyUpIiwidGVydGlhcnlCb3JkZXJDb2xvciI6ImhzbCg4MCwgNjAlLCA4Ni4yNzQ1MDk4MDM5JSkiLCJwcmltYXJ5VGV4dENvbG9yIjoiIzEzMTMwMCIsInNlY29uZGFyeVRleHRDb2xvciI6IiMwMDAwMjEiLCJ0ZXJ0aWFyeVRleHRDb2xvciI6InJnYig5LjUwMDAwMDAwMDEsIDkuNTAwMDAwMDAwMSwgOS41MDAwMDAwMDAxKSIsImxpbmVDb2xvciI6IiMzMzMzMzMiLCJ0ZXh0Q29sb3IiOiIjMzMzIiwibWFpbkJrZyI6IiNFQ0VDRkYiLCJzZWNvbmRCa2ciOiIjZmZmZmRlIiwiYm9yZGVyMSI6IiM5MzcwREIiLCJib3JkZXIyIjoiI2FhYWEzMyIsImFycm93aGVhZENvbG9yIjoiIzMzMzMzMyIsImZvbnRGYW1pbHkiOiJcInRyZWJ1Y2hldCBtc1wiLCB2ZXJkYW5hLCBhcmlhbCIsImZvbnRTaXplIjoiMTZweCIsImxhYmVsQmFja2dyb3VuZCI6IiNlOGU4ZTgiLCJub2RlQmtnIjoiI0VDRUNGRiIsIm5vZGVCb3JkZXIiOiIjOTM3MERCIiwiY2x1c3RlckJrZyI6IiNmZmZmZGUiLCJjbHVzdGVyQm9yZGVyIjoiI2FhYWEzMyIsImRlZmF1bHRMaW5rQ29sb3IiOiIjMzMzMzMzIiwidGl0bGVDb2xvciI6IiMzMzMiLCJlZGdlTGFiZWxCYWNrZ3JvdW5kIjoiI2U4ZThlOCIsImFjdG9yQm9yZGVyIjoiaHNsKDI1OS42MjYxNjgyMjQzLCA1OS43NzY1MzYzMTI4JSwgODcuOTAxOTYwNzg0MyUpIiwiYWN0b3JCa2ciOiIjRUNFQ0ZGIiwiYWN0b3JUZXh0Q29sb3IiOiJibGFjayIsImFjdG9yTGluZUNvbG9yIjoiZ3JleSIsInNpZ25hbENvbG9yIjoiIzMzMyIsInNpZ25hbFRleHRDb2xvciI6IiMzMzMiLCJsYWJlbEJveEJrZ0NvbG9yIjoiI0VDRUNGRiIsImxhYmVsQm94Qm9yZGVyQ29sb3IiOiJoc2woMjU5LjYyNjE2ODIyNDMsIDU5Ljc3NjUzNjMxMjglLCA4Ny45MDE5NjA3ODQzJSkiLCJsYWJlbFRleHRDb2xvciI6ImJsYWNrIiwibG9vcFRleHRDb2xvciI6ImJsYWNrIiwibm90ZUJvcmRlckNvbG9yIjoiI2FhYWEzMyIsIm5vdGVCa2dDb2xvciI6IiNmZmY1YWQiLCJub3RlVGV4dENvbG9yIjoiYmxhY2siLCJhY3RpdmF0aW9uQm9yZGVyQ29sb3IiOiIjNjY2IiwiYWN0aXZhdGlvbkJrZ0NvbG9yIjoiI2Y0ZjRmNCIsInNlcXVlbmNlTnVtYmVyQ29sb3IiOiJ3aGl0ZSIsInNlY3Rpb25Ca2dDb2xvciI6InJnYmEoMTAyLCAxMDIsIDI1NSwgMC40OSkiLCJhbHRTZWN0aW9uQmtnQ29sb3IiOiJ3aGl0ZSIsInNlY3Rpb25Ca2dDb2xvcjIiOiIjZmZmNDAwIiwidGFza0JvcmRlckNvbG9yIjoiIzUzNGZiYyIsInRhc2tCa2dDb2xvciI6IiM4YTkwZGQiLCJ0YXNrVGV4dExpZ2h0Q29sb3IiOiJ3aGl0ZSIsInRhc2tUZXh0Q29sb3IiOiJ3aGl0ZSIsInRhc2tUZXh0RGFya0NvbG9yIjoiYmxhY2siLCJ0YXNrVGV4dE91dHNpZGVDb2xvciI6ImJsYWNrIiwidGFza1RleHRDbGlja2FibGVDb2xvciI6IiMwMDMxNjMiLCJhY3RpdmVUYXNrQm9yZGVyQ29sb3IiOiIjNTM0ZmJjIiwiYWN0aXZlVGFza0JrZ0NvbG9yIjoiI2JmYzdmZiIsImdyaWRDb2xvciI6ImxpZ2h0Z3JleSIsImRvbmVUYXNrQmtnQ29sb3IiOiJsaWdodGdyZXkiLCJkb25lVGFza0JvcmRlckNvbG9yIjoiZ3JleSIsImNyaXRCb3JkZXJDb2xvciI6IiNmZjg4ODgiLCJjcml0QmtnQ29sb3IiOiJyZWQiLCJ0b2RheUxpbmVDb2xvciI6InJlZCIsImxhYmVsQ29sb3IiOiJibGFjayIsImVycm9yQmtnQ29sb3IiOiIjNTUyMjIyIiwiZXJyb3JUZXh0Q29sb3IiOiIjNTUyMjIyIiwiY2xhc3NUZXh0IjoiIzEzMTMwMCIsImZpbGxUeXBlMCI6IiNFQ0VDRkYiLCJmaWxsVHlwZTEiOiIjZmZmZmRlIiwiZmlsbFR5cGUyIjoiaHNsKDMwNCwgMTAwJSwgOTYuMjc0NTA5ODAzOSUpIiwiZmlsbFR5cGUzIjoiaHNsKDEyNCwgMTAwJSwgOTMuNTI5NDExNzY0NyUpIiwiZmlsbFR5cGU0IjoiaHNsKDE3NiwgMTAwJSwgOTYuMjc0NTA5ODAzOSUpIiwiZmlsbFR5cGU1IjoiaHNsKC00LCAxMDAlLCA5My41Mjk0MTE3NjQ3JSkiLCJmaWxsVHlwZTYiOiJoc2woOCwgMTAwJSwgOTYuMjc0NTA5ODAzOSUpIiwiZmlsbFR5cGU3IjoiaHNsKDE4OCwgMTAwJSwgOTMuNTI5NDExNzY0NyUpIn19LCJ1cGRhdGVFZGl0b3IiOmZhbHNlfQ)](https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoic3RhdGVEaWFncmFtXG5zdGF0ZSBcImNyZWF0ZSBoYXNoIGZvciBjdXJyZW50IGRlc2NyaXB0b3Igc3RhdGVcIiBhcyBzMVxuc3RhdGUgXCJjaGVjayBwcm9ncmFtIGNhY2hlIGZvciBtYXRjaGluZyBzZXRcIiBhcyBzMlxuc3RhdGUgXCJtYXRjaCBmb3VuZFwiIGFzIHMzXG5zdGF0ZSBcInJldHVybiBkZXNjcmlwdG9yIHNldFwiIGFzIHM0XG5zdGF0ZSBcIm1hdGNoIG5vdCBmb3VuZFwiIGFzIHM1XG5zdGF0ZSBcImNoZWNrIHByb2dyYW0gZm9yIHVudXNlZCBzZXRcIiBhcyBzNlxuc3RhdGUgXCJ1bnVzZWQgc2V0IGZvdW5kXCIgYXMgczdcbnN0YXRlIFwiYXNzb2NpYXRlIHNldCB3aXRoIGRlc2NyaXB0b3Igc3RhdGVcIiBhcyBzOFxuc3RhdGUgXCJ1bnVzZWQgc2V0IG5vdCBmb3VuZFwiIGFzIHM5XG5zdGF0ZSBcImFsbG9jYXRlIG5ldyBzZXRcIiBhcyBzMTBcbnN0YXRlIFwicmVzb3VyY2UgaXMgZGVzdHJveWVkXCIgYXMgczExXG5zdGF0ZSBcImFzc29jaWF0ZSByZXNvdXJjZXMgd2l0aCBzZXRcIiBhcyBzMTJcbnN0YXRlIFwiaW52YWxpZGF0ZSBhc3NvY2lhdGVkIHNldHNcIiBhcyBzMTNcbnN0YXRlIFwibW92ZSBpbnZhbGlkYXRlZCBzZXRzIHRvIGludmFsaWRhdGVkIHNldCBhcnJheVwiIGFzIHMxNFxuc3RhdGUgXCJpbnZhbGlkYXRlIHNldFwiIGFzIHMxNlxuc3RhdGUgXCJzZXQgaXMgdmFsaWRcIiBhcyBzMTdcbnN0YXRlIFwic2V0IGlzIG5vdCB2YWxpZFwiIGFzIHMxOFxuc3RhdGUgXCJjaGVjayBwcm9ncmFtIGludmFsaWRhdGVkIHNldCBhcnJheVwiIGFzIHMxOVxuc3RhdGUgXCJpbnZhbGlkYXRlZCBzZXQgbm90IGZvdW5kXCIgYXMgczIwXG5zdGF0ZSBcImludmFsaWRhdGVkIHNldCBmb3VuZFwiIGFzIHMyMVxuWypdIC0tPiBzMVxuczEgLS0-IHMyXG5zMiAtLT4gczNcbnMzIC0tPiBzNFxuczIgLS0-IHM1XG5zNSAtLT4gczE5XG5zMTkgLS0-IHMyMVxuczIxIC0tPiBzOFxuczE5IC0tPiBzMjBcbnMyMCAtLT4gczZcbnM2IC0tPiBzN1xuczcgLS0-IHMxN1xuczE3IC0tPiBzMTZcbnMxNiAtLT4gczhcbnM3IC0tPiBzMThcbnMxOCAtLT4gczhcbnM4IC0tPiBzMTJcbnMxMiAtLT4gczRcbnM2IC0tPiBzOVxuczkgLS0-IHMxMFxuczEwIC0tPiBzOFxuWypdIC0tPiBzMTFcbnMxMSAtLT4gczEzXG5zMTMgLS0-IHMxNCIsIm1lcm1haWQiOnsidGhlbWUiOiJkZWZhdWx0IiwidGhlbWVWYXJpYWJsZXMiOnsiYmFja2dyb3VuZCI6IndoaXRlIiwicHJpbWFyeUNvbG9yIjoiI0VDRUNGRiIsInNlY29uZGFyeUNvbG9yIjoiI2ZmZmZkZSIsInRlcnRpYXJ5Q29sb3IiOiJoc2woODAsIDEwMCUsIDk2LjI3NDUwOTgwMzklKSIsInByaW1hcnlCb3JkZXJDb2xvciI6ImhzbCgyNDAsIDYwJSwgODYuMjc0NTA5ODAzOSUpIiwic2Vjb25kYXJ5Qm9yZGVyQ29sb3IiOiJoc2woNjAsIDYwJSwgODMuNTI5NDExNzY0NyUpIiwidGVydGlhcnlCb3JkZXJDb2xvciI6ImhzbCg4MCwgNjAlLCA4Ni4yNzQ1MDk4MDM5JSkiLCJwcmltYXJ5VGV4dENvbG9yIjoiIzEzMTMwMCIsInNlY29uZGFyeVRleHRDb2xvciI6IiMwMDAwMjEiLCJ0ZXJ0aWFyeVRleHRDb2xvciI6InJnYig5LjUwMDAwMDAwMDEsIDkuNTAwMDAwMDAwMSwgOS41MDAwMDAwMDAxKSIsImxpbmVDb2xvciI6IiMzMzMzMzMiLCJ0ZXh0Q29sb3IiOiIjMzMzIiwibWFpbkJrZyI6IiNFQ0VDRkYiLCJzZWNvbmRCa2ciOiIjZmZmZmRlIiwiYm9yZGVyMSI6IiM5MzcwREIiLCJib3JkZXIyIjoiI2FhYWEzMyIsImFycm93aGVhZENvbG9yIjoiIzMzMzMzMyIsImZvbnRGYW1pbHkiOiJcInRyZWJ1Y2hldCBtc1wiLCB2ZXJkYW5hLCBhcmlhbCIsImZvbnRTaXplIjoiMTZweCIsImxhYmVsQmFja2dyb3VuZCI6IiNlOGU4ZTgiLCJub2RlQmtnIjoiI0VDRUNGRiIsIm5vZGVCb3JkZXIiOiIjOTM3MERCIiwiY2x1c3RlckJrZyI6IiNmZmZmZGUiLCJjbHVzdGVyQm9yZGVyIjoiI2FhYWEzMyIsImRlZmF1bHRMaW5rQ29sb3IiOiIjMzMzMzMzIiwidGl0bGVDb2xvciI6IiMzMzMiLCJlZGdlTGFiZWxCYWNrZ3JvdW5kIjoiI2U4ZThlOCIsImFjdG9yQm9yZGVyIjoiaHNsKDI1OS42MjYxNjgyMjQzLCA1OS43NzY1MzYzMTI4JSwgODcuOTAxOTYwNzg0MyUpIiwiYWN0b3JCa2ciOiIjRUNFQ0ZGIiwiYWN0b3JUZXh0Q29sb3IiOiJibGFjayIsImFjdG9yTGluZUNvbG9yIjoiZ3JleSIsInNpZ25hbENvbG9yIjoiIzMzMyIsInNpZ25hbFRleHRDb2xvciI6IiMzMzMiLCJsYWJlbEJveEJrZ0NvbG9yIjoiI0VDRUNGRiIsImxhYmVsQm94Qm9yZGVyQ29sb3IiOiJoc2woMjU5LjYyNjE2ODIyNDMsIDU5Ljc3NjUzNjMxMjglLCA4Ny45MDE5NjA3ODQzJSkiLCJsYWJlbFRleHRDb2xvciI6ImJsYWNrIiwibG9vcFRleHRDb2xvciI6ImJsYWNrIiwibm90ZUJvcmRlckNvbG9yIjoiI2FhYWEzMyIsIm5vdGVCa2dDb2xvciI6IiNmZmY1YWQiLCJub3RlVGV4dENvbG9yIjoiYmxhY2siLCJhY3RpdmF0aW9uQm9yZGVyQ29sb3IiOiIjNjY2IiwiYWN0aXZhdGlvbkJrZ0NvbG9yIjoiI2Y0ZjRmNCIsInNlcXVlbmNlTnVtYmVyQ29sb3IiOiJ3aGl0ZSIsInNlY3Rpb25Ca2dDb2xvciI6InJnYmEoMTAyLCAxMDIsIDI1NSwgMC40OSkiLCJhbHRTZWN0aW9uQmtnQ29sb3IiOiJ3aGl0ZSIsInNlY3Rpb25Ca2dDb2xvcjIiOiIjZmZmNDAwIiwidGFza0JvcmRlckNvbG9yIjoiIzUzNGZiYyIsInRhc2tCa2dDb2xvciI6IiM4YTkwZGQiLCJ0YXNrVGV4dExpZ2h0Q29sb3IiOiJ3aGl0ZSIsInRhc2tUZXh0Q29sb3IiOiJ3aGl0ZSIsInRhc2tUZXh0RGFya0NvbG9yIjoiYmxhY2siLCJ0YXNrVGV4dE91dHNpZGVDb2xvciI6ImJsYWNrIiwidGFza1RleHRDbGlja2FibGVDb2xvciI6IiMwMDMxNjMiLCJhY3RpdmVUYXNrQm9yZGVyQ29sb3IiOiIjNTM0ZmJjIiwiYWN0aXZlVGFza0JrZ0NvbG9yIjoiI2JmYzdmZiIsImdyaWRDb2xvciI6ImxpZ2h0Z3JleSIsImRvbmVUYXNrQmtnQ29sb3IiOiJsaWdodGdyZXkiLCJkb25lVGFza0JvcmRlckNvbG9yIjoiZ3JleSIsImNyaXRCb3JkZXJDb2xvciI6IiNmZjg4ODgiLCJjcml0QmtnQ29sb3IiOiJyZWQiLCJ0b2RheUxpbmVDb2xvciI6InJlZCIsImxhYmVsQ29sb3IiOiJibGFjayIsImVycm9yQmtnQ29sb3IiOiIjNTUyMjIyIiwiZXJyb3JUZXh0Q29sb3IiOiIjNTUyMjIyIiwiY2xhc3NUZXh0IjoiIzEzMTMwMCIsImZpbGxUeXBlMCI6IiNFQ0VDRkYiLCJmaWxsVHlwZTEiOiIjZmZmZmRlIiwiZmlsbFR5cGUyIjoiaHNsKDMwNCwgMTAwJSwgOTYuMjc0NTA5ODAzOSUpIiwiZmlsbFR5cGUzIjoiaHNsKDEyNCwgMTAwJSwgOTMuNTI5NDExNzY0NyUpIiwiZmlsbFR5cGU0IjoiaHNsKDE3NiwgMTAwJSwgOTYuMjc0NTA5ODAzOSUpIiwiZmlsbFR5cGU1IjoiaHNsKC00LCAxMDAlLCA5My41Mjk0MTE3NjQ3JSkiLCJmaWxsVHlwZTYiOiJoc2woOCwgMTAwJSwgOTYuMjc0NTA5ODAzOSUpIiwiZmlsbFR5cGU3IjoiaHNsKDE4OCwgMTAwJSwgOTMuNTI5NDExNzY0NyUpIn19LCJ1cGRhdGVFZGl0b3IiOmZhbHNlfQ)

Just a very normal cache mechanism. The problem, as I said previously, was that there was just way too much hashing going on, and so the performance ended up being worse than a dumb bucket allocator.

Not ideal.

But I kept turning the idea over in the back of my mind, and then I realized that part of the problem was in the upper-right block named `move invalidated sets to invalidated set array`. It ended up being the case that my resource tracking for descriptor sets was far too invasive; I had separate hash tables on every resource to track every set that a resource was attached to at all times, and I was basically spending all my time modifying those hash tables, not even the actual descriptor set caching.

So then I thought: well, what if I just don't track it that closely?

[![](https://mermaid.ink/img/eyJjb2RlIjoic3RhdGVEaWFncmFtXG5zdGF0ZSBcImNyZWF0ZSBoYXNoIGZvciBjdXJyZW50IGRlc2NyaXB0b3Igc3RhdGVcIiBhcyBzMVxuc3RhdGUgXCJjaGVjayBwcm9ncmFtIGNhY2hlIGZvciBtYXRjaGluZyBzZXRcIiBhcyBzMlxuc3RhdGUgXCJtYXRjaCBmb3VuZFwiIGFzIHMzXG5zdGF0ZSBcInJldHVybiBkZXNjcmlwdG9yIHNldFwiIGFzIHM0XG5zdGF0ZSBcIm1hdGNoIG5vdCBmb3VuZFwiIGFzIHM1XG5zdGF0ZSBcImNoZWNrIHByb2dyYW0gZm9yIHVudXNlZCBzZXRcIiBhcyBzNlxuc3RhdGUgXCJ1bnVzZWQgc2V0IGZvdW5kXCIgYXMgczdcbnN0YXRlIFwiYXNzb2NpYXRlIHNldCB3aXRoIGRlc2NyaXB0b3Igc3RhdGVcIiBhcyBzOFxuc3RhdGUgXCJ1bnVzZWQgc2V0IG5vdCBmb3VuZFwiIGFzIHM5XG5zdGF0ZSBcImFsbG9jYXRlIG5ldyBzZXRcIiBhcyBzMTBcbnN0YXRlIFwicmVzb3VyY2UgaXMgZGVzdHJveWVkXCIgYXMgczExXG5zdGF0ZSBcImFzc29jaWF0ZSByZXNvdXJjZXMgd2l0aCBzZXRcIiBhcyBzMTJcbnN0YXRlIFwiaW52YWxpZGF0ZSBhc3NvY2lhdGVkIHNldHNcIiBhcyBzMTNcbnN0YXRlIFwiaW52YWxpZGF0ZSBzZXRcIiBhcyBzMTZcbnN0YXRlIFwic2V0IGlzIHZhbGlkXCIgYXMgczE3XG5zdGF0ZSBcInNldCBpcyBub3QgdmFsaWRcIiBhcyBzMThcbnN0YXRlIFwiY2hlY2sgcHJvZ3JhbSBhbGxvY2F0aW9uIGJ1Y2tldFwiIGFzIHMxOVxuc3RhdGUgXCJubyBzZXQgZm91bmRcIiBhcyBzMjBcbnN0YXRlIFwic2V0IGZvdW5kXCIgYXMgczIxXG5bKl0gLS0-IHMxXG5zMSAtLT4gczJcbnMyIC0tPiBzM1xuczMgLS0-IHM0XG5zMiAtLT4gczVcbnM1IC0tPiBzMTlcbnMxOSAtLT4gczIxXG5zMjEgLS0-IHM4XG5zMTkgLS0-IHMyMFxuczIwIC0tPiBzNlxuczYgLS0-IHM3XG5zNyAtLT4gczE3XG5zMTcgLS0-IHMxNlxuczE2IC0tPiBzOFxuczcgLS0-IHMxOFxuczE4IC0tPiBzOFxuczggLS0-IHMxMlxuczEyIC0tPiBzNFxuczYgLS0-IHM5XG5zOSAtLT4gczEwXG5zMTAgLS0-IHM4XG5bKl0gLS0-IHMxMVxuczExIC0tPiBzMTMiLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCIsInRoZW1lVmFyaWFibGVzIjp7ImJhY2tncm91bmQiOiJ3aGl0ZSIsInByaW1hcnlDb2xvciI6IiNFQ0VDRkYiLCJzZWNvbmRhcnlDb2xvciI6IiNmZmZmZGUiLCJ0ZXJ0aWFyeUNvbG9yIjoiaHNsKDgwLCAxMDAlLCA5Ni4yNzQ1MDk4MDM5JSkiLCJwcmltYXJ5Qm9yZGVyQ29sb3IiOiJoc2woMjQwLCA2MCUsIDg2LjI3NDUwOTgwMzklKSIsInNlY29uZGFyeUJvcmRlckNvbG9yIjoiaHNsKDYwLCA2MCUsIDgzLjUyOTQxMTc2NDclKSIsInRlcnRpYXJ5Qm9yZGVyQ29sb3IiOiJoc2woODAsIDYwJSwgODYuMjc0NTA5ODAzOSUpIiwicHJpbWFyeVRleHRDb2xvciI6IiMxMzEzMDAiLCJzZWNvbmRhcnlUZXh0Q29sb3IiOiIjMDAwMDIxIiwidGVydGlhcnlUZXh0Q29sb3IiOiJyZ2IoOS41MDAwMDAwMDAxLCA5LjUwMDAwMDAwMDEsIDkuNTAwMDAwMDAwMSkiLCJsaW5lQ29sb3IiOiIjMzMzMzMzIiwidGV4dENvbG9yIjoiIzMzMyIsIm1haW5Ca2ciOiIjRUNFQ0ZGIiwic2Vjb25kQmtnIjoiI2ZmZmZkZSIsImJvcmRlcjEiOiIjOTM3MERCIiwiYm9yZGVyMiI6IiNhYWFhMzMiLCJhcnJvd2hlYWRDb2xvciI6IiMzMzMzMzMiLCJmb250RmFtaWx5IjoiXCJ0cmVidWNoZXQgbXNcIiwgdmVyZGFuYSwgYXJpYWwiLCJmb250U2l6ZSI6IjE2cHgiLCJsYWJlbEJhY2tncm91bmQiOiIjZThlOGU4Iiwibm9kZUJrZyI6IiNFQ0VDRkYiLCJub2RlQm9yZGVyIjoiIzkzNzBEQiIsImNsdXN0ZXJCa2ciOiIjZmZmZmRlIiwiY2x1c3RlckJvcmRlciI6IiNhYWFhMzMiLCJkZWZhdWx0TGlua0NvbG9yIjoiIzMzMzMzMyIsInRpdGxlQ29sb3IiOiIjMzMzIiwiZWRnZUxhYmVsQmFja2dyb3VuZCI6IiNlOGU4ZTgiLCJhY3RvckJvcmRlciI6ImhzbCgyNTkuNjI2MTY4MjI0MywgNTkuNzc2NTM2MzEyOCUsIDg3LjkwMTk2MDc4NDMlKSIsImFjdG9yQmtnIjoiI0VDRUNGRiIsImFjdG9yVGV4dENvbG9yIjoiYmxhY2siLCJhY3RvckxpbmVDb2xvciI6ImdyZXkiLCJzaWduYWxDb2xvciI6IiMzMzMiLCJzaWduYWxUZXh0Q29sb3IiOiIjMzMzIiwibGFiZWxCb3hCa2dDb2xvciI6IiNFQ0VDRkYiLCJsYWJlbEJveEJvcmRlckNvbG9yIjoiaHNsKDI1OS42MjYxNjgyMjQzLCA1OS43NzY1MzYzMTI4JSwgODcuOTAxOTYwNzg0MyUpIiwibGFiZWxUZXh0Q29sb3IiOiJibGFjayIsImxvb3BUZXh0Q29sb3IiOiJibGFjayIsIm5vdGVCb3JkZXJDb2xvciI6IiNhYWFhMzMiLCJub3RlQmtnQ29sb3IiOiIjZmZmNWFkIiwibm90ZVRleHRDb2xvciI6ImJsYWNrIiwiYWN0aXZhdGlvbkJvcmRlckNvbG9yIjoiIzY2NiIsImFjdGl2YXRpb25Ca2dDb2xvciI6IiNmNGY0ZjQiLCJzZXF1ZW5jZU51bWJlckNvbG9yIjoid2hpdGUiLCJzZWN0aW9uQmtnQ29sb3IiOiJyZ2JhKDEwMiwgMTAyLCAyNTUsIDAuNDkpIiwiYWx0U2VjdGlvbkJrZ0NvbG9yIjoid2hpdGUiLCJzZWN0aW9uQmtnQ29sb3IyIjoiI2ZmZjQwMCIsInRhc2tCb3JkZXJDb2xvciI6IiM1MzRmYmMiLCJ0YXNrQmtnQ29sb3IiOiIjOGE5MGRkIiwidGFza1RleHRMaWdodENvbG9yIjoid2hpdGUiLCJ0YXNrVGV4dENvbG9yIjoid2hpdGUiLCJ0YXNrVGV4dERhcmtDb2xvciI6ImJsYWNrIiwidGFza1RleHRPdXRzaWRlQ29sb3IiOiJibGFjayIsInRhc2tUZXh0Q2xpY2thYmxlQ29sb3IiOiIjMDAzMTYzIiwiYWN0aXZlVGFza0JvcmRlckNvbG9yIjoiIzUzNGZiYyIsImFjdGl2ZVRhc2tCa2dDb2xvciI6IiNiZmM3ZmYiLCJncmlkQ29sb3IiOiJsaWdodGdyZXkiLCJkb25lVGFza0JrZ0NvbG9yIjoibGlnaHRncmV5IiwiZG9uZVRhc2tCb3JkZXJDb2xvciI6ImdyZXkiLCJjcml0Qm9yZGVyQ29sb3IiOiIjZmY4ODg4IiwiY3JpdEJrZ0NvbG9yIjoicmVkIiwidG9kYXlMaW5lQ29sb3IiOiJyZWQiLCJsYWJlbENvbG9yIjoiYmxhY2siLCJlcnJvckJrZ0NvbG9yIjoiIzU1MjIyMiIsImVycm9yVGV4dENvbG9yIjoiIzU1MjIyMiIsImNsYXNzVGV4dCI6IiMxMzEzMDAiLCJmaWxsVHlwZTAiOiIjRUNFQ0ZGIiwiZmlsbFR5cGUxIjoiI2ZmZmZkZSIsImZpbGxUeXBlMiI6ImhzbCgzMDQsIDEwMCUsIDk2LjI3NDUwOTgwMzklKSIsImZpbGxUeXBlMyI6ImhzbCgxMjQsIDEwMCUsIDkzLjUyOTQxMTc2NDclKSIsImZpbGxUeXBlNCI6ImhzbCgxNzYsIDEwMCUsIDk2LjI3NDUwOTgwMzklKSIsImZpbGxUeXBlNSI6ImhzbCgtNCwgMTAwJSwgOTMuNTI5NDExNzY0NyUpIiwiZmlsbFR5cGU2IjoiaHNsKDgsIDEwMCUsIDk2LjI3NDUwOTgwMzklKSIsImZpbGxUeXBlNyI6ImhzbCgxODgsIDEwMCUsIDkzLjUyOTQxMTc2NDclKSJ9fSwidXBkYXRlRWRpdG9yIjpmYWxzZX0)](https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoic3RhdGVEaWFncmFtXG5zdGF0ZSBcImNyZWF0ZSBoYXNoIGZvciBjdXJyZW50IGRlc2NyaXB0b3Igc3RhdGVcIiBhcyBzMVxuc3RhdGUgXCJjaGVjayBwcm9ncmFtIGNhY2hlIGZvciBtYXRjaGluZyBzZXRcIiBhcyBzMlxuc3RhdGUgXCJtYXRjaCBmb3VuZFwiIGFzIHMzXG5zdGF0ZSBcInJldHVybiBkZXNjcmlwdG9yIHNldFwiIGFzIHM0XG5zdGF0ZSBcIm1hdGNoIG5vdCBmb3VuZFwiIGFzIHM1XG5zdGF0ZSBcImNoZWNrIHByb2dyYW0gZm9yIHVudXNlZCBzZXRcIiBhcyBzNlxuc3RhdGUgXCJ1bnVzZWQgc2V0IGZvdW5kXCIgYXMgczdcbnN0YXRlIFwiYXNzb2NpYXRlIHNldCB3aXRoIGRlc2NyaXB0b3Igc3RhdGVcIiBhcyBzOFxuc3RhdGUgXCJ1bnVzZWQgc2V0IG5vdCBmb3VuZFwiIGFzIHM5XG5zdGF0ZSBcImFsbG9jYXRlIG5ldyBzZXRcIiBhcyBzMTBcbnN0YXRlIFwicmVzb3VyY2UgaXMgZGVzdHJveWVkXCIgYXMgczExXG5zdGF0ZSBcImFzc29jaWF0ZSByZXNvdXJjZXMgd2l0aCBzZXRcIiBhcyBzMTJcbnN0YXRlIFwiaW52YWxpZGF0ZSBhc3NvY2lhdGVkIHNldHNcIiBhcyBzMTNcbnN0YXRlIFwiaW52YWxpZGF0ZSBzZXRcIiBhcyBzMTZcbnN0YXRlIFwic2V0IGlzIHZhbGlkXCIgYXMgczE3XG5zdGF0ZSBcInNldCBpcyBub3QgdmFsaWRcIiBhcyBzMThcbnN0YXRlIFwiY2hlY2sgcHJvZ3JhbSBhbGxvY2F0aW9uIGJ1Y2tldFwiIGFzIHMxOVxuc3RhdGUgXCJubyBzZXQgZm91bmRcIiBhcyBzMjBcbnN0YXRlIFwic2V0IGZvdW5kXCIgYXMgczIxXG5bKl0gLS0-IHMxXG5zMSAtLT4gczJcbnMyIC0tPiBzM1xuczMgLS0-IHM0XG5zMiAtLT4gczVcbnM1IC0tPiBzMTlcbnMxOSAtLT4gczIxXG5zMjEgLS0-IHM4XG5zMTkgLS0-IHMyMFxuczIwIC0tPiBzNlxuczYgLS0-IHM3XG5zNyAtLT4gczE3XG5zMTcgLS0-IHMxNlxuczE2IC0tPiBzOFxuczcgLS0-IHMxOFxuczE4IC0tPiBzOFxuczggLS0-IHMxMlxuczEyIC0tPiBzNFxuczYgLS0-IHM5XG5zOSAtLT4gczEwXG5zMTAgLS0-IHM4XG5bKl0gLS0-IHMxMVxuczExIC0tPiBzMTMiLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCIsInRoZW1lVmFyaWFibGVzIjp7ImJhY2tncm91bmQiOiJ3aGl0ZSIsInByaW1hcnlDb2xvciI6IiNFQ0VDRkYiLCJzZWNvbmRhcnlDb2xvciI6IiNmZmZmZGUiLCJ0ZXJ0aWFyeUNvbG9yIjoiaHNsKDgwLCAxMDAlLCA5Ni4yNzQ1MDk4MDM5JSkiLCJwcmltYXJ5Qm9yZGVyQ29sb3IiOiJoc2woMjQwLCA2MCUsIDg2LjI3NDUwOTgwMzklKSIsInNlY29uZGFyeUJvcmRlckNvbG9yIjoiaHNsKDYwLCA2MCUsIDgzLjUyOTQxMTc2NDclKSIsInRlcnRpYXJ5Qm9yZGVyQ29sb3IiOiJoc2woODAsIDYwJSwgODYuMjc0NTA5ODAzOSUpIiwicHJpbWFyeVRleHRDb2xvciI6IiMxMzEzMDAiLCJzZWNvbmRhcnlUZXh0Q29sb3IiOiIjMDAwMDIxIiwidGVydGlhcnlUZXh0Q29sb3IiOiJyZ2IoOS41MDAwMDAwMDAxLCA5LjUwMDAwMDAwMDEsIDkuNTAwMDAwMDAwMSkiLCJsaW5lQ29sb3IiOiIjMzMzMzMzIiwidGV4dENvbG9yIjoiIzMzMyIsIm1haW5Ca2ciOiIjRUNFQ0ZGIiwic2Vjb25kQmtnIjoiI2ZmZmZkZSIsImJvcmRlcjEiOiIjOTM3MERCIiwiYm9yZGVyMiI6IiNhYWFhMzMiLCJhcnJvd2hlYWRDb2xvciI6IiMzMzMzMzMiLCJmb250RmFtaWx5IjoiXCJ0cmVidWNoZXQgbXNcIiwgdmVyZGFuYSwgYXJpYWwiLCJmb250U2l6ZSI6IjE2cHgiLCJsYWJlbEJhY2tncm91bmQiOiIjZThlOGU4Iiwibm9kZUJrZyI6IiNFQ0VDRkYiLCJub2RlQm9yZGVyIjoiIzkzNzBEQiIsImNsdXN0ZXJCa2ciOiIjZmZmZmRlIiwiY2x1c3RlckJvcmRlciI6IiNhYWFhMzMiLCJkZWZhdWx0TGlua0NvbG9yIjoiIzMzMzMzMyIsInRpdGxlQ29sb3IiOiIjMzMzIiwiZWRnZUxhYmVsQmFja2dyb3VuZCI6IiNlOGU4ZTgiLCJhY3RvckJvcmRlciI6ImhzbCgyNTkuNjI2MTY4MjI0MywgNTkuNzc2NTM2MzEyOCUsIDg3LjkwMTk2MDc4NDMlKSIsImFjdG9yQmtnIjoiI0VDRUNGRiIsImFjdG9yVGV4dENvbG9yIjoiYmxhY2siLCJhY3RvckxpbmVDb2xvciI6ImdyZXkiLCJzaWduYWxDb2xvciI6IiMzMzMiLCJzaWduYWxUZXh0Q29sb3IiOiIjMzMzIiwibGFiZWxCb3hCa2dDb2xvciI6IiNFQ0VDRkYiLCJsYWJlbEJveEJvcmRlckNvbG9yIjoiaHNsKDI1OS42MjYxNjgyMjQzLCA1OS43NzY1MzYzMTI4JSwgODcuOTAxOTYwNzg0MyUpIiwibGFiZWxUZXh0Q29sb3IiOiJibGFjayIsImxvb3BUZXh0Q29sb3IiOiJibGFjayIsIm5vdGVCb3JkZXJDb2xvciI6IiNhYWFhMzMiLCJub3RlQmtnQ29sb3IiOiIjZmZmNWFkIiwibm90ZVRleHRDb2xvciI6ImJsYWNrIiwiYWN0aXZhdGlvbkJvcmRlckNvbG9yIjoiIzY2NiIsImFjdGl2YXRpb25Ca2dDb2xvciI6IiNmNGY0ZjQiLCJzZXF1ZW5jZU51bWJlckNvbG9yIjoid2hpdGUiLCJzZWN0aW9uQmtnQ29sb3IiOiJyZ2JhKDEwMiwgMTAyLCAyNTUsIDAuNDkpIiwiYWx0U2VjdGlvbkJrZ0NvbG9yIjoid2hpdGUiLCJzZWN0aW9uQmtnQ29sb3IyIjoiI2ZmZjQwMCIsInRhc2tCb3JkZXJDb2xvciI6IiM1MzRmYmMiLCJ0YXNrQmtnQ29sb3IiOiIjOGE5MGRkIiwidGFza1RleHRMaWdodENvbG9yIjoid2hpdGUiLCJ0YXNrVGV4dENvbG9yIjoid2hpdGUiLCJ0YXNrVGV4dERhcmtDb2xvciI6ImJsYWNrIiwidGFza1RleHRPdXRzaWRlQ29sb3IiOiJibGFjayIsInRhc2tUZXh0Q2xpY2thYmxlQ29sb3IiOiIjMDAzMTYzIiwiYWN0aXZlVGFza0JvcmRlckNvbG9yIjoiIzUzNGZiYyIsImFjdGl2ZVRhc2tCa2dDb2xvciI6IiNiZmM3ZmYiLCJncmlkQ29sb3IiOiJsaWdodGdyZXkiLCJkb25lVGFza0JrZ0NvbG9yIjoibGlnaHRncmV5IiwiZG9uZVRhc2tCb3JkZXJDb2xvciI6ImdyZXkiLCJjcml0Qm9yZGVyQ29sb3IiOiIjZmY4ODg4IiwiY3JpdEJrZ0NvbG9yIjoicmVkIiwidG9kYXlMaW5lQ29sb3IiOiJyZWQiLCJsYWJlbENvbG9yIjoiYmxhY2siLCJlcnJvckJrZ0NvbG9yIjoiIzU1MjIyMiIsImVycm9yVGV4dENvbG9yIjoiIzU1MjIyMiIsImNsYXNzVGV4dCI6IiMxMzEzMDAiLCJmaWxsVHlwZTAiOiIjRUNFQ0ZGIiwiZmlsbFR5cGUxIjoiI2ZmZmZkZSIsImZpbGxUeXBlMiI6ImhzbCgzMDQsIDEwMCUsIDk2LjI3NDUwOTgwMzklKSIsImZpbGxUeXBlMyI6ImhzbCgxMjQsIDEwMCUsIDkzLjUyOTQxMTc2NDclKSIsImZpbGxUeXBlNCI6ImhzbCgxNzYsIDEwMCUsIDk2LjI3NDUwOTgwMzklKSIsImZpbGxUeXBlNSI6ImhzbCgtNCwgMTAwJSwgOTMuNTI5NDExNzY0NyUpIiwiZmlsbFR5cGU2IjoiaHNsKDgsIDEwMCUsIDk2LjI3NDUwOTgwMzklKSIsImZpbGxUeXBlNyI6ImhzbCgxODgsIDEwMCUsIDkzLjUyOTQxMTc2NDclKSJ9fSwidXBkYXRlRWRpdG9yIjpmYWxzZX0)

Indeed, this simplifies things a bit at the conceptual level, since now I can avoid doing any sort of hashing related to resources, though this does end up making my second-level descriptor set cache less effective. But I'm getting ahead of myself in this post, so it's time to jump into some code.

## Resource Tracking 2.0
Instead of doing really precise tracking, it's important to recall a few key points about how the descriptor sets are managed:
* they're bucket allocated
* they're allocated using the `struct zink_program` ralloc context
* they're only ever destroyed when the program is
* zink is single-threaded

Thus, I brought some pointer hacks to bear:
```c
void
zink_resource_desc_set_add(struct zink_resource *res, struct zink_descriptor_set *zds, unsigned idx)
{
   zds->resources[idx] = res;
   util_dynarray_append(&res->desc_set_refs, struct zink_resource**, &zds->resources[idx]);
}
```
This function associates a resource with a given descriptor set at the specified index (based on pipeline state). And then it pushes a reference to that pointer from the descriptor set's C-array of resources into an array on the resource.

Later, during resource destruction, I can then walk the array of pointers like this:
```c
util_dynarray_foreach(&res->desc_set_refs, struct zink_resource **, ref) {
   if (**ref == res)
      **ref = NULL;
}
```
If the reference I pushed earlier is still pointing to this resource, I can unset the pointer, and this will get picked up during future descriptor updates to flag the set as not-cached, requiring that it be updated. Since a resource won't ever be destroyed while a set is in use, this is also safe for the associated descriptor set's lifetime.

And since there's no hashing or tree traversals involved, this is incredibly fast.

## Second-level Caching
At this point, I'd created two categories for descriptor sets: *active* sets, which were the ones in use in a command buffer, and *inactive* sets, which were the ones that weren't currently in use, with sets being pushed into the *inactive* category once they were no longer used by any command buffers. This ended up being a bit of a waste, however, as I had lots of "inactive" sets that were still valid but unreachable since I was using an array for storing these as well as the newly-bucket-allocated sets.

Thus, a second-level cache, AKA the B cache, which would store not-used sets that had at one point been valid. I'm still not doing any sort of checking of sets which may have been invalidated by resource destruction, so the B cache isn't quite as useful as it could be. Also:
* the `check program cache for matching set` has now been expanded to two lookups in case a matching set isn't *active* but is still configured and valid in the B cache
* the `check program for unused set` block in the above diagram will now cannibalize a valid *inactive* set from the B cache rather than allocate a new set

The last of these items is a bit annoying, but ultimately the B cache can end up having hundreds of members at various points, and iterating through it to try and find a set that's been invalidated ends up being impractical just based on the random distribution of sets across the table. Also, I only set the resource-based invalidation up to null the resource pointer, so finding an invalid set would mean walking through the resource array of each set in the cache. Thus, a quick iteration through a few items to see if the set-finder gets lucky, otherwise it's clobbering time.

And this brought me up to about 24fps, which was still down a bit from the mind-blowing 27-28fps I was getting with just the bucket allocator, but it turns out that caching starts to open up other avenues for sizable optimizations.

Which I'll get to in future posts.
