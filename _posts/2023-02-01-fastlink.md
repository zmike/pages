---
published: false
---
## Fastlinking: This Is Your Howto

I previously wrote a post talking about some optimization work that's been done with RADV to improve fast-link performance. As promised, that wasn't the end of the story. Today's post will be a bit different, however, as I'll be assuming all my graphics experts in the audience are already well-versed in all the topics I'm covering.

Also I'm assuming you're all driver developers interested in improving your GPL fastlink performance.

## Testing
To begin evaluating your fastlink performance, it's important to have test cases. Benchmarks. The sort of thing you can easily run, easily profile, easily understand the results you see.

[vkoverhead](https://github.com/zmike/vkoverhead) is the premiere tool for evaluating CPU overhead in Vulkan drivers, and thanks to Valve, it now has support for GPL fastlink based on real pipelines used in Dota2.

For anyone interested in running these cases, it's as simple as building and then running:

`./vkoverhead -start 135`

These benchmark cases will call `vkCreateGraphicsPipelines` in a tight loop to perform a fast-link on GPL-created pipeline libraries, fast-linking thousands of times per second for easy profiling. The number of iterations per second, in thousands, is then printed.

vkoverhead works with any Vulkan driver on any platform (including Windows!), which means it's possible to use it to profile and optimize any driver.

## Optimization
vkoverhead currently has two cases for GPL fastlink. As they are both extracted directly from Dota2, they have a number of properties in common:
* similar descriptor layouts/requirements
* same composition of libraries (all four GPL stages created separately)

Each case tests the following:
* `depthonly` is a pipeline containing only a vertex shader, forcing the driver to use its own fragment shader
* `slow` is a pipeline that happens to be slow to create on many drivers

Various tools are available on different platforms for profiling, and I'm not going to go into details there. What I'm going to do instead is look into strategies for optimizing drivers. Strategies that I (and others) have employed in real drivers. Strategies that you, if you aren't shipping a fast-linking implementation of GPL, might be interested in implementing.

## First Strategy: Move NO-OP Fragment Shader To Device


anv
```
$ ./vkoverhead -start 135 -duration 5
vkoverhead running on Intel(R) Iris(R) Plus Graphics (ICL GT2):
	* misc numbers are reported as thousands of operations per second
	* percentages for misc cases should be ignored
 135, misc_compile_fastlink_depthonly,                      384,          100.0%
 136, misc_compile_fastlink_slow,                           276,          100.0%

$ VK_ICD_FILENAMES=/usr/local/share/vulkan/icd.d/lvp_icd.x86_64.json ./vkoverhead -start 135 -duration 5
vkoverhead running on llvmpipe (LLVM 15.0.6, 256 bits):
	* misc numbers are reported as thousands of operations per second
	* percentages for misc cases should be ignored
 135, misc_compile_fastlink_depthonly,                      571,          100.0%
 136, misc_compile_fastlink_slow,                           607,          100.0%
```


radv
```
$ VK_ICD_FILENAMES=/usr/share/vulkan/icd.d/nvidia_icd.json ./vkoverhead -start 135 -duration 5
vkoverhead running on NVIDIA GeForce RTX 2070:
	* misc numbers are reported as thousands of operations per second
	* percentages for misc cases should be ignored
 135, misc_compile_fastlink_depthonly,                      444,          100.0%
 136, misc_compile_fastlink_slow,                           243,          100.0%
 
$ RADV_PERFTEST=gpl ./vkoverhead -start 135 -duration 5
vkoverhead running on AMD Radeon RX 5700 XT (RADV NAVI10):
	* misc numbers are reported as thousands of operations per second
	* percentages for misc cases should be ignored
 135, misc_compile_fastlink_depthonly,                      301,          100.0%
 136, misc_compile_fastlink_slow,                           283,          100.0%

$ VK_ICD_FILENAMES=/usr/local/share/vulkan/icd.d/lvp_icd.x86_64.json ./vkoverhead -start 135 -duration 5
vkoverhead running on llvmpipe (LLVM 15.0.6, 256 bits):                                                                   
	* misc numbers are reported as thousands of operations per second
	* percentages for misc cases should be ignored
 135, misc_compile_fastlink_depthonly,                      544,          100.0%
 136, misc_compile_fastlink_slow,                           536,          100.0%
```


tu
```
$ ./vkoverhead -start 135
vkoverhead running on Turnip Adreno (TM) 618:
	* misc numbers are reported as thousands of operations per second
	* percentages for misc cases should be ignored
 135, misc_compile_fastlink_depthonly,                       73,           100.0%
 136, misc_compile_fastlink_slow,                            23,           100.0%

$ VK_ICD_FILENAMES=/usr/local/share/vulkan/icd.d/lvp_icd.aarch64.json ./vkoverhead -start 135
vkoverhead running on llvmpipe (LLVM 14.0.6, 128 bits):
	* misc numbers are reported as thousands of operations per second
	* percentages for misc cases should be ignored
 135, misc_compile_fastlink_depthonly,                      331,          100.0%
 136, misc_compile_fastlink_slow,                           361,          100.0%
```

| Item         | Price | # In stock |
|--------------|:-----:|-----------:|
| Juicy Apples |  1.99 |        739 |
| Bananas      |  1.89 |          6 |
